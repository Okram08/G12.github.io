<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G12 - Dépôt USDC sur BASE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background: #0a101a;
      color: #eaf6ff;
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 420px;
      margin: 3rem auto 0;
      background: rgba(18,22,32,0.97);
      border-radius: 18px;
      padding: 2.5rem 1.7rem 2.2rem;
      box-shadow: 0 8px 32px #3ee6e055;
      text-align: center;
    }
    h1 {
      color: #3ee6e0;
      font-size: 2.1rem;
      margin-bottom: 0.7rem;
    }
    .subtitle {
      color: #b2c2d6;
      margin-bottom: 2rem;
    }
    .cta-btn {
      background: linear-gradient(90deg, #3ee6e0, #3a8dde);
      color: #0a101a;
      padding: 1rem 2.2rem;
      border-radius: 40px;
      font-weight: 700;
      font-size: 1.1rem;
      margin: 1.2rem auto 2rem;
      display: inline-block;
      box-shadow: 0 6px 24px rgba(62,230,224,0.22);
      cursor: pointer;
      border: none;
      transition: all 0.23s;
    }
    .cta-btn:hover {
      background: linear-gradient(90deg, #3a8dde, #3ee6e0);
      color: #fff;
      transform: scale(1.04);
    }
    label {
      display: block;
      margin-bottom: 0.4rem;
      color: #b2c2d6;
      font-weight: 500;
      text-align: left;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.85rem;
      border-radius: 10px;
      border: 1px solid #3ee6e022;
      background: rgba(255,255,255,0.04);
      color: #eaf6ff;
      margin-bottom: 1.1rem;
      font-size: 1.1rem;
      transition: border 0.2s;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: #3ee6e0;
    }
    #status {
      margin-top: 1.3rem;
      min-height: 2.2em;
      color: #3ee6e0;
      font-weight: 600;
    }
    .info {
      margin: 2.2rem 0 0.5rem;
      color: #b2c2d6;
      font-size: 0.98rem;
      background: rgba(62,230,224,0.07);
      border-radius: 8px;
      padding: 1rem;
    }
    .success {
      color: #3ee6e0;
    }
    .error {
      color: #ff6b81;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dépôt USDC sur BASE</h1>
    <div class="subtitle">Dépose tes USDC sur le vault sécurisé Gnosis Safe</div>
    <button id="connectWallet" class="cta-btn">Connecter mon wallet</button>
    <form id="usdcDepositForm" style="display:none;">
      <label for="usdcAmount">Montant à déposer (USDC) :</label>
      <input type="number" id="usdcAmount" min="1" step="any" required placeholder="Ex: 100">
      <button type="submit" class="cta-btn">Déposer sur le vault</button>
    </form>
    <div id="status"></div>
    <div class="info">
      <strong>Réseau :</strong> Base Mainnet<br>
      <strong>Adresse du vault :</strong> <span id="safeAddr"></span><br>
      <strong>Token USDC (Base) :</strong> <span id="usdcAddr"></span>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    // === CONFIGURATION À PERSONNALISER ===
    const safeAddress = "0x1234567890abcdef1234567890abcdef12345678"; // <-- ADRESSE DE TON GNOSIS SAFE SUR BASE
    const usdcAddress = "0xd9aaEC86b65d86f6a7B5b1b0c42f7bD6d6f5F3C4"; // <-- USDC OFFICIEL SUR BASE (vérifie sur basescan.org)
    const usdcDecimals = 6;
    // ======================================

    document.getElementById('safeAddr').textContent = safeAddress;
    document.getElementById('usdcAddr').textContent = usdcAddress;

    let provider, signer, userAddress;

    // Connexion wallet
    document.getElementById('connectWallet').onclick = async () => {
      if (!window.ethereum) {
        alert("Installez MetaMask ou un wallet compatible.");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      // Vérifie la chaîne Base (id 8453)
      const { chainId } = await provider.getNetwork();
      if (chainId !== 8453) {
        document.getElementById('status').innerHTML = '<span class="error">Merci de te connecter sur le réseau BASE (id 8453).</span>';
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x2105' }] // 8453 en hexadécimal
          });
        } catch (e) {}
        return;
      }
      document.getElementById('connectWallet').style.display = 'none';
      document.getElementById('usdcDepositForm').style.display = 'block';
      document.getElementById('status').textContent = "Wallet connecté : " + userAddress;
    };

    // Dépôt USDC
    document.getElementById('usdcDepositForm').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('status').innerHTML = "Transaction en cours...";
      try {
        const amount = document.getElementById('usdcAmount').value;
        if (!amount || isNaN(amount) || Number(amount) <= 0) {
          document.getElementById('status').innerHTML = '<span class="error">Montant invalide.</span>';
          return;
        }
        const usdc = new ethers.Contract(usdcAddress, [
          "function approve(address spender, uint256 amount) public returns (bool)",
          "function allowance(address owner, address spender) public view returns (uint256)",
          "function transfer(address to, uint256 amount) public returns (bool)",
          "function decimals() public view returns (uint8)"
        ], signer);

        // Vérifie allowance
        const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);
        const allowance = await usdc.allowance(userAddress, safeAddress);
        if (allowance.lt(amountInWei)) {
          const tx1 = await usdc.approve(safeAddress, amountInWei);
          await tx1.wait();
        }

        // Transfert effectif
        const tx2 = await usdc.transfer(safeAddress, amountInWei);
        await tx2.wait();

        document.getElementById('status').innerHTML = '<span class="success">✅ Dépôt effectué avec succès !</span>';
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerHTML = '<span class="error">Erreur : ' + (err.data?.message || err.message) + '</span>';
      }
    };
  </script>
</body>
</html>
