<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>StableVault Base - D√©p√¥t USDC</title>
  <style>
    /* (Garde ton style existant, j‚Äôenl√®ve pour la clart√© ici) */
  </style>
</head>
<body>
  <h1>StableVault Base - D√©p√¥t USDC</h1>
  <button id="connectButton">Connecter MetaMask</button>
  <p id="status"></p>
  <p id="balance"></p>

  <div id="vault" style="display:none;">
    <h2>D√©poser USDC</h2>
    <input type="number" id="depositAmount" placeholder="Montant USDC" min="0" step="0.01" />
    <button id="depositButton">D√©poser</button>
    <p id="depositStatus"></p>

    <h2>Solde dans le Vault</h2>
    <p id="userShares"></p>
  </div>

  <!-- ethers.js CDN -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
  <script>
    const connectButton = document.getElementById('connectButton');
    const status = document.getElementById('status');
    const balanceEl = document.getElementById('balance');
    const vaultDiv = document.getElementById('vault');
    const depositAmountInput = document.getElementById('depositAmount');
    const depositButton = document.getElementById('depositButton');
    const depositStatus = document.getElementById('depositStatus');
    const userSharesEl = document.getElementById('userShares');

    // Config Base RPC & adresses
    const baseRpcUrl = 'https://mainnet.base.org';
    const USDC_ADDRESS = '0xBaseUSDCAddress'; // Remplace par l'adresse USDC sur Base r√©elle
    const VAULT_ADDRESS = '0xTonVaultTrackerAddress'; // Adresse de ton contrat VaultTracker

    // ABI simplifi√© ERC20 pour approve & balanceOf
    const ERC20_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];

    // ABI VaultTracker simplifi√© (deposit + shares)
    const VAULT_ABI = [
      "function deposit(uint256 amount) external",
      "function shares(address user) view returns (uint256)"
    ];

    let provider;
    let signer;
    let userAddress;
    let usdcContract;
    let vaultContract;

    async function connectMetaMask() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          status.innerText = `Connect√© : ${userAddress}`;
          status.style.color = '#0f0';

          usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
          vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);

          vaultDiv.style.display = 'block';

          await updateUserBalance();
          await updateUserShares();

        } catch (error) {
          status.innerText = 'Connexion refus√©e';
          status.style.color = '#f55';
          console.error(error);
        }
      } else {
        status.innerText = 'MetaMask non d√©tect√©.';
        status.style.color = '#f55';
      }
    }

    async function updateUserBalance() {
      const balance = await usdcContract.balanceOf(userAddress);
      const decimals = await usdcContract.decimals();
      const formatted = ethers.utils.formatUnits(balance, decimals);
      balanceEl.innerText = `Ton solde USDC : ${formatted}`;
      balanceEl.style.color = '#0f0';
    }

    async function updateUserShares() {
      try {
        const shares = await vaultContract.shares(userAddress);
        const decimals = 6; // m√™me decimals que USDC ici pour simplifier
        const formattedShares = ethers.utils.formatUnits(shares, decimals);
        userSharesEl.innerText = `Tes parts dans le Vault : ${formattedShares}`;
        userSharesEl.style.color = '#0ff';
      } catch(e) {
        userSharesEl.innerText = `Erreur r√©cup√©ration parts : ${e.message}`;
        userSharesEl.style.color = '#f55';
      }
    }

    async function depositUSDC() {
      depositStatus.innerText = '';
      const amount = depositAmountInput.value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        depositStatus.innerText = 'Montant invalide';
        depositStatus.style.color = '#f55';
        return;
      }

      const decimals = 6;
      const amountParsed = ethers.utils.parseUnits(amount, decimals);

      try {
        // V√©rifier l'autorisation actuelle
        const allowance = await usdcContract.allowance(userAddress, VAULT_ADDRESS);
        if (allowance.lt(amountParsed)) {
          depositStatus.innerText = 'Approbation en cours...';
          depositStatus.style.color = '#ff0';
          const txApprove = await usdcContract.approve(VAULT_ADDRESS, amountParsed);
          await txApprove.wait();
        }

        depositStatus.innerText = 'D√©p√¥t en cours...';
        const txDeposit = await vaultContract.deposit(amountParsed);
        await txDeposit.wait();

        depositStatus.innerText = 'D√©p√¥t r√©ussi ! üéâ';
        depositStatus.style.color = '#0f0';

        await updateUserBalance();
        await updateUserShares();

      } catch (error) {
        depositStatus.innerText = `Erreur : ${error.message}`;
        depositStatus.style.color = '#f55';
        console.error(error);
      }
    }

    connectButton.addEventListener('click', connectMetaMask);
    depositButton.addEventListener('click', depositUSDC);
  </script>
</body>
</html>
