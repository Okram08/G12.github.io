<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G12 - Dépôt USDC sur BASE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* ... (identique à ton CSS) ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>Dépôt USDC sur BASE</h1>
    <div class="subtitle">Dépose tes USDC sur le vault sécurisé Gnosis Safe</div>
    <button id="connectWallet" class="cta-btn">Connecter mon wallet</button>
    <form id="usdcDepositForm" style="display:none;">
      <label for="usdcAmount">Montant à déposer (USDC) :</label>
      <input type="number" id="usdcAmount" min="1" step="any" required placeholder="Ex: 100">
      <button type="submit" class="cta-btn">Déposer sur le vault</button>
    </form>
    <div id="status"></div>
    <div class="info">
      <strong>Réseau :</strong> Base Mainnet<br>
      <strong>Adresse du vault :</strong> <span id="safeAddr"></span><br>
      <strong>Token USDC (Base) :</strong> <span id="usdcAddr"></span>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    window.onload = function() {
      // === CONFIGURATION À PERSONNALISER ===
      const safeAddress = "0x1234567890abcdef1234567890abcdef12345678"; // <-- ADRESSE DE TON GNOSIS SAFE SUR BASE
      const usdcAddress = "0xd9aaEC86b65d86f6a7B5b1b0c42f7bD6d6f5F3C4"; // <-- USDC OFFICIEL SUR BASE
      const usdcDecimals = 6;
      // ======================================

      document.getElementById('safeAddr').textContent = safeAddress;
      document.getElementById('usdcAddr').textContent = usdcAddress;

      let provider, signer, userAddress;

      // Connexion wallet
      document.getElementById('connectWallet').onclick = async () => {
        if (!window.ethereum) {
          alert("Installez MetaMask ou un wallet compatible.");
          return;
        }
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum, "any");
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          // Vérifie la chaîne Base (id 8453)
          const { chainId } = await provider.getNetwork();
          if (chainId !== 8453) {
            document.getElementById('status').innerHTML = '<span class="error">Merci de te connecter sur le réseau BASE (id 8453).</span>';
            try {
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x2105' }]
              });
            } catch (e) {}
            return;
          }
          document.getElementById('connectWallet').style.display = 'none';
          document.getElementById('usdcDepositForm').style.display = 'block';
          document.getElementById('status').textContent = "Wallet connecté : " + userAddress;
        } catch (err) {
          document.getElementById('status').innerHTML = '<span class="error">Erreur lors de la connexion : ' + (err.data?.message || err.message) + '</span>';
        }
      };

      // Dépôt USDC
      document.getElementById('usdcDepositForm').onsubmit = async function(e) {
        e.preventDefault();
        document.getElementById('status').innerHTML = "Transaction en cours...";
        try {
          const amount = document.getElementById('usdcAmount').value;
          if (!amount || isNaN(amount) || Number(amount) <= 0) {
            document.getElementById('status').innerHTML = '<span class="error">Montant invalide.</span>';
            return;
          }
          const usdc = new ethers.Contract(usdcAddress, [
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function allowance(address owner, address spender) public view returns (uint256)",
            "function transfer(address to, uint256 amount) public returns (bool)",
            "function decimals() public view returns (uint8)"
          ], signer);

          const amountInWei = ethers.utils.parseUnits(amount, usdcDecimals);
          const allowance = await usdc.allowance(userAddress, safeAddress);
          if (allowance.lt(amountInWei)) {
            const tx1 = await usdc.approve(safeAddress, amountInWei);
            await tx1.wait();
          }

          const tx2 = await usdc.transfer(safeAddress, amountInWei);
          await tx2.wait();

          document.getElementById('status').innerHTML = '<span class="success">✅ Dépôt effectué avec succès !</span>';
        } catch (err) {
          document.getElementById('status').innerHTML = '<span class="error">Erreur : ' + (err.data?.message || err.message) + '</span>';
        }
      };
    };
  </script>
</body>
</html>
