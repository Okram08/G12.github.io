<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Arbitrage Funding Rate â€“ VEST & Paradex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
      color: #eaf6fb;
    }
    .glass-card {
      background: rgba(18, 32, 47, 0.65);
      border-radius: 22px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.13);
      margin: 2.5rem auto 0 auto;
      padding: 2.5rem 2rem 2rem 2rem;
      max-width: 900px;
      width: 95%;
    }
    h1 {
      text-align: center;
      font-size: 2.2rem;
      font-weight: 700;
      background: linear-gradient(90deg, #4fd1c5 10%, #38a1db 90%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 2rem;
      letter-spacing: 0.5px;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 1.5rem;
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.08);
    }
    th, td {
      padding: 1rem 0.6rem;
      text-align: center;
      font-size: 1.08rem;
    }
    th {
      background: rgba(44, 83, 100, 0.75);
      color: #b7eaff;
      font-weight: 700;
      border-bottom: 2px solid #38a1db;
      letter-spacing: 0.04em;
    }
    tr:not(:last-child) td {
      border-bottom: 1px solid rgba(72, 202, 228, 0.10);
    }
    td {
      color: #eaf6fb;
      transition: background 0.2s;
    }
    tr:hover td {
      background: rgba(72, 202, 228, 0.07);
    }
    .positive {
      color: #38e38d;
      font-weight: 700;
    }
    .negative {
      color: #ff6b81;
      font-weight: 700;
    }
    .apy-badge {
      display: inline-block;
      padding: 0.2em 0.7em;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 700;
      background: linear-gradient(90deg,#38a1db 0%,#4fd1c5 100%);
      color: #fff;
      margin: 0 0.2em;
      letter-spacing: 0.03em;
    }
    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.7s forwards;
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: none;
      }
    }
    .badge {
      display: inline-block;
      background: linear-gradient(90deg, #38a1db 0%, #4fd1c5 100%);
      color: #fff;
      font-size: 0.93em;
      border-radius: 8px;
      padding: 0.18em 0.7em;
      font-weight: 600;
      letter-spacing: 0.03em;
      margin-left: 0.3em;
    }
    .refresh-btn {
      display: block;
      margin: 0 auto 1.2rem auto;
      background: linear-gradient(90deg,#38a1db 0%,#4fd1c5 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0.7em 1.5em;
      font-size: 1.08em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(31,38,135,0.07);
      transition: background 0.2s, transform 0.1s;
    }
    .refresh-btn:hover {
      background: linear-gradient(90deg,#4fd1c5 0%,#38a1db 100%);
      transform: translateY(-2px) scale(1.03);
    }
    @media (max-width: 700px) {
      .glass-card {
        padding: 1rem 0.2rem 1.2rem 0.2rem;
      }
      h1 {
        font-size: 1.1rem;
        margin-bottom: 1.2rem;
      }
      .refresh-btn {
        font-size: 1em;
        padding: 0.6em 1.1em;
        margin-bottom: 0.7em;
      }
      table, thead, tbody, th, tr {
        display: block;
        width: 100%;
      }
      thead {
        display: none;
      }
      tr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(44, 83, 100, 0.55);
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(31,38,135,0.06);
        margin-bottom: 0.5em;
        padding: 0.2em 0.6em;
      }
      td {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        padding: 0.25em 0.3em;
        font-size: 1em;
        border: none;
        background: none;
      }
      td[data-label="Token"] {
        flex: 2 1 0;
        font-size: 1.12em;
        font-weight: 700;
        color: #4fd1c5;
        margin-right: 0.5em;
      }
      td[data-label="APY estimÃ© (%)"] {
        flex: 2 1 0;
        font-size: 1.2em;
        font-weight: bold;
        align-items: center;
        justify-content: center;
        display: flex;
      }
      td[data-label="Long sur"], td[data-label="Short sur"] {
        flex: 1 1 0;
        font-size: 0.98em;
        font-weight: 600;
        margin-right: 0.1em;
      }
      td[data-label="Funding Paradex"],
      td[data-label="Funding VEST"],
      td[data-label="Dernier update"] {
        display: none;
      }
      td:before {
        display: none;
      }
    }
    @media (max-width: 400px) {
      tr {
        flex-direction: column;
        align-items: flex-start;
        padding: 0.2em 0.2em;
      }
      td[data-label="APY estimÃ© (%)"] {
        margin: 0.2em 0;
      }
    }
  </style>
</head>
<body>
  <div class="glass-card fade-in">
    <h1>ðŸ“Š Arbitrage Funding Rate <span class="badge">VEST vs Paradex</span></h1>
    <button class="refresh-btn" onclick="update()">ðŸ”„ Actualiser</button>
    <table>
      <thead>
        <tr>
          <th>Token</th>
          <th>Funding Paradex</th>
          <th>Funding VEST</th>
          <th>Long sur</th>
          <th>Short sur</th>
          <th>APY estimÃ© (%)</th>
          <th>Dernier update</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
    <div style="text-align:center; margin-top:1.2rem; color:#b7eaff; font-size:0.98em;">
      Cliquez sur "Actualiser" pour recharger les donnÃ©es.
    </div>
  </div>
<script>
const pairs = [
  { paradex: "HYPE-USD-PERP", vest: "HYPE-PERP" },
  { paradex: "S-USD-PERP", vest: "S-PERP" },
  { paradex: "ETH-USD-PERP", vest: "ETH-PERP" },
  { paradex: "SEI-USD-PERP", vest: "SEI-PERP" },
  { paradex: "BTC-USD-PERP", vest: "BTC-PERP" }
];

const FUNDING_FREQ = {
  paradex: 3,
  vest: 24
};

function extractTokenName(pairName) {
  return pairName.split('-')[0];
}

async function getParadexRate(market) {
  const url = `https://corsproxy.io/?https://api.prod.paradex.trade/v1/funding/data?market=${market}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Paradex API ${res.status}`);
  const json = await res.json();
  return parseFloat(json.results?.[0]?.funding_rate);
}

async function getVestRate(symbol) {
  const url = `https://corsproxy.io/?https://serverprod.vest.exchange/v2/funding/history?symbol=${symbol}&limit=1`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`VEST API ${res.status}`);
  const json = await res.json();
  return parseFloat(json?.[0]?.oneHrFundingRate);
}

function decidePositions(p, v) {
  const TOL = 0.00001;
  const apy_paradex = p * FUNDING_FREQ.paradex * 365 * 100;
  const apy_vest = v * FUNDING_FREQ.vest * 365 * 100;
  const p_sign = p > TOL ? 1 : (p < -TOL ? -1 : 0);
  const v_sign = v > TOL ? 1 : (v < -TOL ? -1 : 0);

  if (p_sign === -1 && v_sign === 1) {
    const profit = apy_vest - apy_paradex;
    if (profit > 0) {
      return { longExchange: 'Paradex', shortExchange: 'VEST', apyDiff: profit.toFixed(2) };
    }
  } else if (p_sign === 1 && v_sign === -1) {
    const profit = apy_paradex - apy_vest;
    if (profit > 0) {
      return { longExchange: 'VEST', shortExchange: 'Paradex', apyDiff: profit.toFixed(2) };
    }
  }
  if (p_sign === -1 && v_sign === 0) {
    const profit = -apy_paradex;
    if (profit > 0) {
      return { longExchange: 'Paradex', shortExchange: 'VEST', apyDiff: profit.toFixed(2) };
    }
  }
  if (v_sign === -1 && p_sign === 0) {
    const profit = -apy_vest;
    if (profit > 0) {
      return { longExchange: 'VEST', shortExchange: 'Paradex', apyDiff: profit.toFixed(2) };
    }
  }
  return { longExchange: '-', shortExchange: '-', apyDiff: '0.00' };
}

function getApyBadge(apy) {
  if (parseFloat(apy) > 0) {
    return `<span class="apy-badge positive">+${apy}%</span>`;
  } else if (parseFloat(apy) < 0) {
    return `<span class="apy-badge negative">${apy}%</span>`;
  } else {
    return `<span class="apy-badge">${apy}%</span>`;
  }
}

async function update() {
  const tbody = document.getElementById("body");
  tbody.innerHTML = '';
  const isMobile = window.innerWidth <= 700;

  for (const pair of pairs) {
    try {
      const [p, v] = await Promise.all([
        getParadexRate(pair.paradex),
        getVestRate(pair.vest)
      ]);

      if (isNaN(p) || isNaN(v)) throw new Error("Funding rate invalide");

      const { longExchange, shortExchange, apyDiff } = decidePositions(p, v);
      const tokenName = extractTokenName(pair.paradex);

      if (isMobile) {
        tbody.innerHTML += `
          <tr>
            <td data-label="Token">${tokenName}</td>
            <td data-label="APY estimÃ© (%)">${getApyBadge(apyDiff)}</td>
            <td data-label="Long sur">${longExchange}</td>
            <td data-label="Short sur">${shortExchange}</td>
          </tr>
        `;
      } else {
        tbody.innerHTML += `
          <tr>
            <td data-label="Token">${tokenName}</td>
            <td data-label="Funding Paradex" class="${p >= 0 ? 'positive' : 'negative'}">${p.toFixed(6)}</td>
            <td data-label="Funding VEST" class="${v >= 0 ? 'positive' : 'negative'}">${v.toFixed(6)}</td>
            <td data-label="Long sur">${longExchange}</td>
            <td data-label="Short sur">${shortExchange}</td>
            <td data-label="APY estimÃ© (%)">${getApyBadge(apyDiff)}</td>
            <td data-label="Dernier update">${new Date().toLocaleTimeString()}</td>
          </tr>
        `;
      }
    } catch (e) {
      console.error('Erreur pour', pair.paradex, e);
      tbody.innerHTML += `
        <tr>
          <td colspan="7" class="negative">Erreur chargement ${pair.paradex}: ${e.message}</td>
        </tr>`;
    }
  }
}

// RafraÃ®chit aussi lors du redimensionnement (utile pour passage desktop <-> mobile)
window.addEventListener('resize', update);

// Chargement initial
update();
</script>
</body>
</html>
